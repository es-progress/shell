#!/usr/bin/env bash
#####################################
## pass-man                        ##
##                                 ##
## Manages a 'pass' password-store ##
## which is inside a tomb.         ##
#####################################

############
## CONFIG ##
############
# Timer to close tomb automatically
timer=6h

###############
## FUNCTIONS ##
###############

## Usage
########
_usage() {
    cat <<HELP

pass-man v1.1.1
Written by Sandor Semsey, Copyright(C) 2020, License MIT

Usage: vault ACTION [TARGET] [OPTIONS]

ACTION:     open, close, generate, retrieve
TARGET:     Path to password (mandatory for 'retrieve' action)
OPTIONS:    Extra arguments to 'pass'
HELP
    exit 1
}

## Check if tomb is opened
##########################
_check-tomb-open() {
    tomb list >/dev/null 2>&1
}

## Open vault
#############
_vault-open() {
    # shellcheck disable=SC2310
    if ! _check-tomb-open; then
        pass open -f --timer="${timer}"

        if ! _check-tomb-open; then
            echo "Failed to open tomb." >&2
            exit 1
        fi
    fi
}

## Close vault
##############
_vault-close() {
    # shellcheck disable=SC2310
    if _check-tomb-open; then
        pass close

        if _check-tomb-open; then
            echo "Failed to close tomb." >&2
            exit 1
        fi
    fi
}

## Generate new password
########################
_vault-generate() {
    _vault-open
    pass generate -f aaa_tmp "${@}"
}

## Get pass from vault
##
## @param    $1  Path to password
## @param    $@  Extra arguments to 'pass'
##########################################
_vault-retrieve() {
    local path="${1?:"Path to password missing"}"
    shift
    _vault-open
    pass "${@}" "${path}"
}

##################
## SCRIPT START ##
##################

# Strict mode
set -euo pipefail
IFS=$'\n\t'

# Parse options
action="${1:-}"
[[ -n "${action}" ]] && shift

# Switch action
case "${action}" in
    open) _vault-open ;;
    close) _vault-close ;;
    generate) _vault-generate "${@}" ;;
    retrieve)
        pass_path="${1:-}"
        if [[ -n "${pass_path}" ]]; then
            shift
        else
            echo "Path to password missing" >&2
            _usage
        fi
        _vault-retrieve "${pass_path}" "${@}"
        ;;
    "") echo "Action missing" >&2 && _usage ;;
    *) echo "Invalid action" >&2 && _usage ;;
esac

exit 0
