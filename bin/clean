#!/usr/bin/env bash
##############################
## clean                    ##
##                          ##
## Remove unneeded packages ##
## Remove old snaps         ##
## Flush journal            ##
## Delete caches            ##
##############################

###############
## FUNCTIONS ##
###############

## Version
##########
_version() {
    cat <<VERSION
clean v1.1.0
Written by Sandor Semsey, Copyright (C) 2023, License MIT
VERSION
}

## Usage
########
_usage() {
    cat <<HELP

Usage: clean [OPTIONS]...

Clean-up temporary and other unused files to free up disk space

OPTIONS

  -j, --journal [TIME]       Remove journal older than this time (specified with the usual "s", "m", "h", etc. suffixes).
                             Defaults to 2 weeks (2w).
  -u, --user [USER]          Clear temp files in user's HOME also.
                             Can be specified multiple times to clean more user HOME.
  -q, --quiet                Suppress non-error messages
  -h, --help                 Display this help
  -v, --version              Print version info
HELP
}

##################
## SCRIPT START ##
##################

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

# Parse options
###############
journal_retention=2w
users=()
quiet=()
redirection=/dev/stdout

while :; do
    case "${1:-}" in
        -j | --journal)
            shift
            journal_retention="${1}"
            ;;
        -u | --user)
            shift
            users+=("${1}")
            ;;
        -q | --quiet)
            quiet=(--quiet)
            redirection=/dev/null
            ;;
        -h | --help)
            _version
            _usage
            exit 0
            ;;
        -v | --version)
            _version
            exit 0
            ;;
        "") break ;;
        *)
            echo "Not supported option: ${1}"
            _usage
            exit 1
            ;;
    esac
    shift
done

echo Clean APT...
sudo apt-get autoremove --purge --yes "${quiet[@]}" "${quiet[@]}"
sudo apt-get clean --yes "${quiet[@]}" "${quiet[@]}"
echo APT cleaned.

echo Clean snap...
for line in $(snap list --all | awk '/disabled/{print $1, $3}'); do
    IFS=$' \t' read -r snapname revision <<< "${line}"
    # shellcheck disable=SC2024
    sudo snap remove "${snapname}" --purge --revision="${revision}" > "${redirection}"
done
echo Snaps cleaned.

echo Rotate journal...
sudo journalctl --flush --rotate --vacuum-time="${journal_retention}" "${quiet[@]}"
echo Journal rotated.

echo -n Flush system caches...
[[ -d /var/cache ]] && sudo find /var/cache -mindepth 1 -delete
[[ -d /var/lib/snapd/cache ]] && sudo find /var/lib/snapd/cache -mindepth 1 -delete
echo Done.

# User caches
for user in "${users[@]}"; do
    if ! homedir=$(getent passwd "${user}" | cut -d: -f6); then
        echo "User not exits: ${user}" 1>&2
        exit 1
    fi

    echo "Clean-up for ${user}..."

    echo -n Empty trash bin...
    sudo test -d "${homedir}/.local/share/Trash" && sudo find "${homedir}/.local/share/Trash" -mindepth 1 -delete
    echo Done.

    echo -n Flush general cache...
    sudo test -d "${homedir}/.cache" && sudo find "${homedir}/.cache" -mindepth 1 -delete
    echo Done.

    echo -n Flush Atom cache...
    sudo test -d "${homedir}/.atom/.apm/_cacache" && sudo find "${homedir}/.atom/.apm/_cacache" -mindepth 1 -delete
    echo Done.

    echo -n Flush Chrome cache...
    sudo test -d "${homedir}/.config/google-chrome" && sudo find "${homedir}/.config/google-chrome" -mindepth 1 -delete
    echo Done.

    echo -n "Flush gdfuse (Google Drive FS) cache..."
    sudo test -d "${homedir}/.gdfuse/${user}/cache" && sudo find "${homedir}/.gdfuse/${user}/cache" -mindepth 1 -delete
    echo Done.

    echo -n Flush Spotify cache...
    sudo test -d "${homedir}/snap/spotify/common/.cache" && sudo find "${homedir}/snap/spotify/common/.cache" -mindepth 1 -delete
    echo Done.

    echo "Cleanup finished for ${user}."
done

exit 0
