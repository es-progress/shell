#!/usr/bin/env bash
##############################
## clean                    ##
##                          ##
## Remove unneeded packages ##
## Remove old snaps         ##
## Flush journal            ##
## Delete caches            ##
##############################

# Config
journal_retention=2w

# Strict mode
set -eufo pipefail
IFS=$'\n\t'

# apt
sudo apt-get autoremove --purge --yes
sudo apt-get clean --yes

# snap
for line in $(snap list --all | awk '/disabled/{print $1, $3}'); do
    IFS=$' \t' read -r snapname revision <<< "${line}"
    sudo snap remove "${snapname}" --purge --revision="${revision}"
done

# Rotate journal
sudo journalctl --flush --rotate --vacuum-time="${journal_retention}"

# cache
sudo find /var/cache -mindepth 1 -delete
sudo find /var/lib/snapd/cache -mindepth 1 -delete

exit 0
